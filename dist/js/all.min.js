"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),kah=kah||{};kah.tentconfigurator=kah.tentconfigurator||{},kah.tentconfigurator.googleAPILoaded=new Promise(function(t){jQuery(window).on("kahGoogleAPILoaded",function(){t()})}),kah.tentconfigurator.Tent=function t(e,n,r,o,i,a,s){_classCallCheck(this,t),this.id=e,this.title=n,this.price=r,this.length=o,this.width=i,this.minPersons=a,this.maxPersons=s,this.squareMeter=this.length*this.width},kah.tentconfigurator.Equipment=function t(e,n,r,o){_classCallCheck(this,t),this.id=e,this.title=n,this.price=r,this.description=o},kah.tentconfigurator.WizardStep=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,t),this.name=e,this.active=ko.observable(!1),this.activeSubStep=ko.observable(),this.wizardForm=n,this.isVisible=ko.computed(function(){return this.active()&&!this.activeSubStep()},this)}return _createClass(t,[{key:"openSubStep",value:function(t){t.active(!0),this.activeSubStep(t)}},{key:"closeSubStep",value:function(){this.activeSubStep().active(!1),this.activeSubStep(null)}},{key:"removeDataRow",value:function(){throw new Error("Override this function")}}]),t}(),kah.tentconfigurator.WizardSubStep=function(t){function e(t){var n;_classCallCheck(this,e);for(var r=arguments.length,o=Array(r>1?r-1:0),i=1;i<r;i++)o[i-1]=arguments[i];var a=_possibleConstructorReturn(this,(n=e.__proto__||Object.getPrototypeOf(e)).call.apply(n,[this].concat(o)));return a.parent=t,a.isVisible=ko.computed(function(){return this.active()&&this.parent.active()},a),a}return _inherits(e,t),e}(kah.tentconfigurator.WizardStep),kah.tentconfigurator.WizardStepTents=function(t){function e(){var t;_classCallCheck(this,e);for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];var i=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)));return i.selectTentsSubStep=new kah.tentconfigurator.WizardStepSelectTents(i),i}return _inherits(e,t),_createClass(e,[{key:"openSelectTent",value:function(){this.openSubStep(this.selectTentsSubStep)}},{key:"removeDataRow",value:function(t){this.wizardForm.selectedTents.remove(t)}}]),e}(kah.tentconfigurator.WizardStep),kah.tentconfigurator.WizardStepEquipment=function(t){function e(){var t;_classCallCheck(this,e);for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];var i=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)));return i.selectEquipmentubStep=new kah.tentconfigurator.WizardStepSelectEquipment(i),i}return _inherits(e,t),_createClass(e,[{key:"openSelectEquipment",value:function(){this.openSubStep(this.selectEquipmentubStep)}},{key:"removeDataRow",value:function(t){this.wizardForm.selectedEquipment.remove(t)}}]),e}(kah.tentconfigurator.WizardStep),kah.tentconfigurator.WizardStepEvent=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,t),e}(kah.tentconfigurator.WizardStep),kah.tentconfigurator.WizardStepContact=function(t){function e(){var t;_classCallCheck(this,e);for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];var i=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)));return i.availableGenders=ko.observableArray(["Herr","Frau"]),i}return _inherits(e,t),e}(kah.tentconfigurator.WizardStep),kah.tentconfigurator.WizardStepSelectTents=function(t){function e(t){var n;_classCallCheck(this,e);for(var r=arguments.length,o=Array(r>1?r-1:0),i=1;i<r;i++)o[i-1]=arguments[i];return _possibleConstructorReturn(this,(n=e.__proto__||Object.getPrototypeOf(e)).call.apply(n,[this,t].concat(o)))}return _inherits(e,t),_createClass(e,[{key:"selectTent",value:function(t){this.parent.wizardForm.selectedTents.push(Object.assign(new kah.tentconfigurator.Tent,t)),this.parent.closeSubStep()}}]),e}(kah.tentconfigurator.WizardSubStep),kah.tentconfigurator.WizardStepSelectEquipment=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"selectEquipment",value:function(t){this.parent.wizardForm.selectedEquipment.push(Object.assign(new kah.tentconfigurator.Equipment,t)),this.parent.closeSubStep()}}]),e}(kah.tentconfigurator.WizardSubStep),kah.tentconfigurator.WizardForm=function(){function t(){_classCallCheck(this,t),this.firstName=ko.observable(),this.lastName=ko.observable(),this.salutation=ko.observable(),this.company=ko.observable(),this.street=ko.observable(),this.streetnr=ko.observable(),this.zip=ko.observable(),this.location=ko.observable(),this.email=ko.observable(),this.phone=ko.observable(),this.comment=ko.observable(),this.acceptTerms=ko.observable(!1),this.eventname=ko.observable(),this.eventdays=ko.observable(1),this.eventlocation=ko.observable(),this.eventlocationdistance=ko.observable(0),this.eventstartdate=ko.observable(),this.tents=ko.observableArray(),this.equipment=ko.observableArray(),this.selectedTents=ko.observableArray(),this.selectedEquipment=ko.observableArray(),this.transportPrice=ko.computed(function(){return this.eventlocationdistance()<=1e4?0:50*Math.ceil(this.eventlocationdistance()/1e3/30)*2},this),this.totalTentsPrice=ko.computed(function(){return this._count_objs_attribute(this.selectedTents(),"price")},this),this.totalEquipmentPrice=ko.computed(function(){return this._count_objs_attribute(this.selectedEquipment(),"price")},this),this.totalPrice=ko.computed(function(){return(this.totalTentsPrice()+this.totalEquipmentPrice())*this.eventdays()+this.transportPrice()},this),this.totalMinPersons=ko.computed(function(){return this._count_objs_attribute(this.selectedTents(),"minPersons")},this),this.totalMaxPersons=ko.computed(function(){return this._count_objs_attribute(this.selectedTents(),"maxPersons")},this),this.totalSquareMeters=ko.computed(function(){return this._count_objs_attribute(this.selectedTents(),"squareMeter")},this)}return _createClass(t,[{key:"_count_objs_attribute",value:function(t,e){var n=0;return t.forEach(function(t){n+=t[e]}),n}}]),t}(),kah.tentconfigurator.Wizard=function(){function t(){_classCallCheck(this,t),this.debug=!1,"undefined"==typeof ajaxurl&&(this.debug=!0),this.loadData(),this.form=new kah.tentconfigurator.WizardForm,this.mode=ko.observable(0),this.submitted=ko.observable(!1),this.steps=ko.observableArray([new kah.tentconfigurator.WizardStepTents("Zelt",this.form),new kah.tentconfigurator.WizardStepEquipment("Zubehör",this.form),new kah.tentconfigurator.WizardStepEvent("Anlass",this.form),new kah.tentconfigurator.WizardStepContact("Kontakt",this.form)]),this.addressNotFound=ko.observable(!1),this.currentStep=ko.observable(this.steps()[0]),this.isLastStep=ko.computed(function(){return this.currentWizardStepId()>=this.steps().length-1},this),this.showPrevButton=ko.computed(function(){return this.currentWizardStepId()>0},this),this.nextButtonText=ko.computed(function(){return this.isLastStep()?"Offerte anfordern":"Weiter"},this),this.showNextButton=!0,ko.computed(function(){var t=!0,e=!1,n=void 0;try{for(var r,o=this.steps()[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var i=r.value;i.active(!1),this.currentStep()==i&&i.active(!0)}}catch(t){e=!0,n=t}finally{try{!t&&o.return&&o.return()}finally{if(e)throw n}}},this),jQuery(document).on("focusout","input[required], select[required]",function(t){return function(){t.validateField(this)}}(this)),kah.tentconfigurator.googleAPILoaded.then(function(t){return function(){t.initGoogleSearch()}}(this))}return _createClass(t,[{key:"next",value:function(){this.isLastStep()?this.send():this.currentStep(this.steps()[this.currentWizardStepId()+1])}},{key:"previous",value:function(){this.currentStep(this.steps()[this.currentWizardStepId()-1])}},{key:"loadData",value:function(){var t=this,e=this._make_request({action:"kah_get_data"});e.then(function(e){var n=[],r=[];t.debug?(n=[new kah.tentconfigurator.Tent(1,"Zelttitel 1",0,4,20,100,150),new kah.tentconfigurator.Tent(2,"Zelttitel 2",30,8,20,200,300),new kah.tentconfigurator.Tent(3,"Zelttitel 3",50,12,20,150,300)],r=[new kah.tentconfigurator.Equipment(1,"Lampe",5,"kleine Lampe für das DJ Pult"),new kah.tentconfigurator.Equipment(2,"Bodenplatte 30x30 cm",0,"Um den Boden zu schützen"),new kah.tentconfigurator.Equipment(3,"Tisch - 3 Meter ",9,"für 6 Personen"),new kah.tentconfigurator.Equipment(4,"Tisch - 5 Meter ",9,"für 9 Personen")]):(e.tents.forEach(function(t){n.push(new kah.tentconfigurator.Tent(t.id,t.title,t.price,t.length,t.width,t.minPersons,t.maxPersons))}),e.equipment.forEach(function(t){r.push(new kah.tentconfigurator.Equipment(t.id,t.title,t.price,t.description))})),t.form.tents(n),t.form.equipment(r)})}},{key:"send",value:function(){if(jQuery(window).scrollTop(0),!this.validateForm())return void this.mode(4);this.mode(3);var t=this,e={action:"kah_send_offer",salutation:this.form.salutation(),firstName:this.form.firstName(),lastName:this.form.lastName(),company:this.form.company(),street:this.form.street(),streetnr:this.form.streetnr(),zip:this.form.zip(),location:this.form.location(),email:this.form.email(),phone:this.form.phone(),comment:this.form.comment(),acceptTerms:this.form.acceptTerms(),eventname:this.form.eventname(),eventdays:this.form.eventdays(),eventlocation:this.form.eventlocation(),eventlocationdistance:this.form.eventlocationdistance(),eventstartdate:this.form.eventstartdate(),transportPrice:this.form.transportPrice(),totalTentsPrice:this.form.totalTentsPrice(),totalEquipmentPrice:this.form.totalEquipmentPrice(),totalPrice:this.form.totalPrice(),totalMinPersons:this.form.totalMinPersons(),totalMaxPersons:this.form.totalMaxPersons(),totalSquareMeters:this.form.totalSquareMeters(),selectedTents:this.form.selectedTents(),selectedEquipment:this.form.selectedEquipment()},n=this._make_request(e);n.then(function(){t.mode(1),t.submitted(!0)},function(){t.mode(2)})}},{key:"readablePrice",value:function(t){return t+" CHF"}},{key:"readablePersons",value:function(t,e){return t+" - "+e+" Personen"}},{key:"currentWizardStepId",value:function(){return this.steps().indexOf(this.currentStep())}},{key:"_make_request",value:function(t){var e=this;return new Promise(function(n,r){e.debug?window.setTimeout(function(){n()},2e3):jQuery.post(ajaxurl,t).done(function(t){"undefined"==typeof t.success||t.success?n(t):r()}).fail(function(t){r(t)})})}},{key:"validateForm",value:function(){var t=!1;return jQuery("#wizard-form input[required], #wizard-form select[required]").each(function(e){return function(n,r){e.validateField(r)||t||(e.currentStep(ko.dataFor(jQuery(r).closest(".wizardStepView")[0])),t=!0)}}(this)),!t}},{key:"validateField",value:function(t){var e=jQuery(".formValidationError",jQuery(t).closest("td"))[0];return t.checkValidity()?(jQuery(e).hide(),!0):(e.innerHTML=t.validationMessage,jQuery(e).show(),!1)}},{key:"calculateDistance",value:function(t){var e=this;if("undefined"==typeof t)return void e.addressNotFound(!0);var n="Hauptstrasse 95, 1715 Alterswil, Schweiz",r=new google.maps.LatLng(t.geometry.location.lat(),t.geometry.location.lng()),o=new google.maps.DistanceMatrixService;o.getDistanceMatrix({origins:[n],destinations:[r],travelMode:google.maps.TravelMode.DRIVING},function(t,n){if(n==google.maps.DistanceMatrixStatus.OK){var r=t.rows[0].elements[0];r.status==google.maps.DistanceMatrixStatus.OK&&(e.form.eventlocationdistance(r.distance.value),e.addressNotFound(!1))}})}},{key:"initGoogleSearch",value:function(){var t=document.getElementById("eventlocation"),e=new google.maps.places.SearchBox(t);e.addListener("places_changed",function(t){return function(){t.calculateDistance(e.getPlaces()[0])}}(this)),google.maps.event.addDomListener(t,"keydown",function(t){13==t.keyCode&&t.preventDefault()})}}]),t}(),kah.tentconfigurator.initGoogleSearch=function(){jQuery(window).trigger("kahGoogleAPILoaded")},jQuery(window).on("load",function(){jQuery("#wizard-form").length>0&&ko.applyBindings(new kah.tentconfigurator.Wizard,document.getElementById("wizard-form"))});